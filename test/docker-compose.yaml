services:
  local:
    build:
      context: ..
      dockerfile: test/local.Dockerfile
    environment:
      CURRENT_BRANCH: ${CURRENT_BRANCH}
      CI: true
    command: >
      /bin/bash -c "
      $$HOME/.dotfiles/dotfiles.sh install
      && $$HOME/.dotfiles/dotfiles.sh test
      "
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
  remote:
    build:
      context: ..
      dockerfile: test/remote.Dockerfile
    command: >
      /bin/bash -c "
      bash <(curl -fSL# $$RAW_CONTENT_URL/dotfiles.sh) install
      && $$HOME/.dotfiles/dotfiles.sh test
      "
    environment:
      RAW_CONTENT_URL: ${RAW_CONTENT_URL}
      CURRENT_BRANCH: ${CURRENT_BRANCH}
      CI: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
