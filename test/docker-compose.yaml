services:
  local:
    build:
      context: ..
      dockerfile: test/local.Dockerfile
    environment:
      CURRENT_BRANCH: ${CURRENT_BRANCH}
    command: >
      /bin/bash -c "
      $$HOME/.dotfiles/dotfiles.sh install
      && source $$HOME/.bashrc
      && $$HOME/.dotfiles/dotfiles.sh test
      "
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
  remote:
    build:
      context: ..
      dockerfile: test/remote.Dockerfile
    environment:
      CURRENT_BRANCH: ${CURRENT_BRANCH}
    command: >
      /bin/bash -c "
      URL="https://raw.githubusercontent.com/omar-besbes/.dotfiles/$$CURRENT_BRANCH"
      && bash <(curl -fSL# $$URL/dotfiles.sh) install
      && source $$HOME/.bashrc
      && $$HOME/.dotfiles/dotfiles.sh test
      "
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
